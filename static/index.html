<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Grid</title>
<style>
  html,body{height:100%;margin:0}
  #c{display:block;width:100%;height:100%}
</style>
</head>
<body>
<div id="ui" style="position:absolute;top:8px;left:8px;z-index:10;background:#fff;border:1px solid #ccc;border-radius:6px;padding:6px 8px;font:13px/1.3 system-ui,Segoe UI,Arial;display:flex;gap:6px;align-items:center">
  <select id="mapSel"></select>
  <input id="newMap" placeholder="new id (4 letters)" maxlength="4" style="width:120px" />
  <button id="createBtn">Create</button>
</div>
<canvas id="c"></canvas>
<script>
const canvas=document.getElementById('c')
const ctx=canvas.getContext('2d')
let dpr=window.devicePixelRatio||1
function size(){const r=canvas.getBoundingClientRect();canvas.width=Math.max(1,Math.round(r.width*dpr));canvas.height=Math.max(1,Math.round(r.height*dpr));}
let tile=64
const Z=8
let MAP_ID='difq'
const tiles=new Map()
function key(x,y){return x+','+y}
let zoom=0
let originX=0
let originY=0
let pan=false
let lastX=0,lastY=0
function draw(){const r=canvas.getBoundingClientRect();ctx.setTransform(dpr,0,0,dpr,0,0);ctx.clearRect(0,0,r.width,r.height);const scale=Math.pow(2,zoom);const spacing=tile*scale;ctx.strokeStyle='rgba(0,0,0,0.25)';ctx.lineWidth=1;let startX=originX%spacing; if(startX<0) startX+=spacing; for(let x=startX;x<=r.width;x+=spacing){ctx.beginPath();ctx.moveTo(Math.round(x)+0.5,0);ctx.lineTo(Math.round(x)+0.5,r.height);ctx.stroke()}let startY=originY%spacing; if(startY<0) startY+=spacing; for(let y=startY;y<=r.height;y+=spacing){ctx.beginPath();ctx.moveTo(0,Math.round(y)+0.5);ctx.lineTo(r.width,Math.round(y)+0.5);ctx.stroke()}const s=Math.pow(2,zoom);tiles.forEach(v=>{const sx=Math.round(originX+v.x*tile*s);const sy=Math.round(originY+v.y*tile*s);const sz=Math.round(tile*s);ctx.drawImage(v.img,sx,sy,sz,sz)})}
window.addEventListener('resize',()=>{size();draw()})
canvas.addEventListener('mousedown',e=>{if(e.button!==0)return;pan=true;lastX=e.clientX;lastY=e.clientY})
window.addEventListener('mouseup',()=>{pan=false})
window.addEventListener('mousemove',e=>{if(!pan)return;originX+=e.clientX-lastX;originY+=e.clientY-lastY;lastX=e.clientX;lastY=e.clientY;draw()})
canvas.addEventListener('wheel',e=>{e.preventDefault();const rect=canvas.getBoundingClientRect();const mx=e.clientX-rect.left;const my=e.clientY-rect.top;const prevScale=Math.pow(2,zoom);const step=e.deltaY<0?0.25:-0.25;zoom=Math.min(6,Math.max(-6,zoom+step));const scale=Math.pow(2,zoom);originX=mx-(mx-originX)*(scale/prevScale);originY=my-(my-originY)*(scale/prevScale);draw()},{passive:false})
canvas.addEventListener('contextmenu',async e=>{e.preventDefault();const rect=canvas.getBoundingClientRect();const mx=e.clientX-rect.left;const my=e.clientY-rect.top;const s=Math.pow(2,zoom);const wx=(mx-originX)/s;const wy=(my-originY)/s;const tx=Math.floor(wx/tile);const ty=Math.floor(wy/tile);const prompt=window.prompt('Prompt');if(!prompt)return;console.log('generate start',{x:tx,y:ty});const r=await fetch(`/maps/${MAP_ID}/generate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({x:tx,y:ty,z:Z,prompt})});const j=await r.json().catch(()=>({ok:false}));console.log('generate resp',j);if(!j.ok)return;const img=new Image();img.onload=()=>{tiles.set(key(tx,ty),{img,x:tx,y:ty});draw()};img.onerror=()=>{console.warn('tile load failed')};img.src=`/maps/${MAP_ID}/tiles/${Z}/${tx}/${ty}.png?t=${Date.now()}`})
size();draw()

async function refreshMaps(){
  try{const r=await fetch('/maps');if(!r.ok)return;const j=await r.json().catch(()=>null);if(!j||!Array.isArray(j.maps))return;const sel=document.getElementById('mapSel');sel.innerHTML='';j.maps.forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;if(id===MAP_ID)o.selected=true;sel.appendChild(o)});sel.onchange=()=>{MAP_ID=sel.value;tiles.clear();draw()}}catch{}
}
document.getElementById('createBtn').onclick=async()=>{const v=(document.getElementById('newMap').value||'').trim().toLowerCase();if(!/^[a-z]{4}$/.test(v))return alert('4 letters');const r=await fetch('/maps',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({map_id:v})});const j=await r.json().catch(()=>({ok:false}));if(j.ok){MAP_ID=v;document.getElementById('newMap').value='';refreshMaps();}}
refreshMaps()
</script>
</body>
</html>
